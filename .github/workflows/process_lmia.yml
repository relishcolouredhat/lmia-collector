name: Fetch and Process LMIA Reports

on:
  # Run automatically every day at 05:00 UTC
  schedule:
    - cron: '0 5 * * *'
  # Allow manual runs from the GitHub Actions tab
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode for manual runs'
        required: false
        default: false
        type: boolean

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (jq, gnumeric, telegraf)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gnumeric
          # Install Telegraf
          wget -q https://dl.influxdata.com/telegraf/releases/telegraf_1.31.1-1_amd64.deb
          sudo dpkg -i telegraf_1.31.1-1_amd64.deb

      - name: Show debug info
        if: ${{ github.event.inputs.debug_mode == 'true' }}
        run: |
          echo "Debug mode enabled"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

      - name: Fetch and process new reports
        id: process
        run: |
          # Create the directory for the script if it doesn't exist
          mkdir -p scripts
          # This assumes your script is in the scripts/ directory
          bash ./scripts/process_feeds.sh

      - name: Show process outputs
        if: ${{ github.event.inputs.debug_mode == 'true' }}
        run: |
          echo "Process outputs:"
          echo "new_files_found: ${{ steps.process.outputs.new_files_found }}"
          echo "new_file_names: ${{ steps.process.outputs.new_file_names }}"

      - name: Commit new files
        if: steps.process.outputs.new_files_found == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@github.com'
          git add .
          # The commit message will include a count of new files
          file_count=$(echo "${{ steps.process.outputs.new_file_names }}" | wc -w)
          git commit -m "Bot: Add ${file_count} new LMIA report(s)" -m "${{ steps.process.outputs.new_file_names }}"
          git push

      - name: Run Telegraf to ingest data
        if: steps.process.outputs.new_files_found == 'true'
        run: |
          echo "New files were found. Running Telegraf..."
          telegraf --once --config="path/to/your/config.conf"
        # Note: Ensure the path to your telegraf config is correct.
        # It should be checked into your repository.

      - name: Manual run summary
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Manual Run Summary ==="
          echo "Run completed at: $(date)"
          echo "New files found: ${{ steps.process.outputs.new_files_found }}"
          if [ "${{ steps.process.outputs.new_files_found }}" = "true" ]; then
            echo "Files added: ${{ steps.process.outputs.new_file_names }}"
          else
            echo "No new files were found to process"
          fi